脚本工具将最常使用脚本查询/替换,模板复制功能抽象出来,方便用户快速上手
---
## 基础操作
- 使用下面的文件为例
```ts
let a = 6;
let b= '123';
```

### 读取上下文节点
```ts
  {
    query: `VariableDeclarationList:has(Identifier[value=a]) LetKeyword`,
    replace: util.statement`${''}1`
  }
```
- 节点内容读取方式为`xx.yy.zz`,为空默认为当前节点
- `replace` 部分为 读取当前节点值与`1`合并到一起作为替换内容
- 不使用`util.statement`时,视为普通字符串,使用`util.statement`时,为标签模板,可以使用一些上下文参数,读取相关内容,返回字符串
- `query`与`replace`属性都可以使用`statement`
- 结果:`let`替换为`let1`

```diff
- let a = 6;
+ let1 a = 6;
  let b= '123';
```

### 读取父级内容
```ts
{
  query: `VariableDeclarationList:has(Identifier[value=a])`,
  children: [{
      query: `LetKeyword`, replace: util.statement`${'parent'}1`
  }],
}
```
```diff
- let a = 6;
+ let a = 61 a = 6;
  let b= '123';
```

### 查询多个节点
```ts
{
  query: `LetKeyword`,
  multi: true,
  replace: `const`
}
```
```diff
- let a = 6;
+ const a = 6;
- let b= '123';
+ const b= '123';
```

### 具名变量
```ts
{
  query: `VariableDeclarationList`,
  children:[
    {query:`LetKeyword`,name:'letVar'}
  ],
  replace:util.statement`${'letVar'}1`
}
```

```diff
- let a = 6;
+ let1
  let b= '123';
```

### 删除节点
```ts
{
    query: `LetKeyword`,
    multi: true,
    delete:true
}
```
```diff
- let a = 6;
+  a = 6;
- let b= '123';
+  b= '123';
```

### 插入到节点前/后
```ts
{
    query: `LetKeyword`,
    multi: true,
    insertBefore:true,
    // insertAfter:true,
    replace:`/**comment*/`
}
```
```diff
- let a = 6;
+ /**comment*/let a = 6;
- let b= '123';
+ /**comment*/let b= '123';
```

### 可选
- 正常查询时,如果查询不到结果,将会抛出异常报错,所以如果不确定是否存在可以使用`optional`,查询失败后,无异常,无回调,不会继续执行子级查询
> 可以设置`description:''`输出报错信息
```ts
{
    query: `AAAA`,
    optional: true,
    children: [
        { query: `BBBB` }
    ]
}
```

### 回调/列表回调
- 如果普通查询不能满足要求,可以使用回调自定义,回调返回的节点将会同样添加到修改列表中
- `listCallback`为`multi: true`时使用
- 下面为使用回调删除节点使用

```ts
{
    query: `LetKeyword`,
    multi: true,
    callback: (context) => { return util.setChange.contextNode(context,'')},
    listCallback: (list, self) => { }
}
```
```diff
- let a = 6;
+  a = 6;
- let b= '123';
+  b= '123';
```

## 进阶操作

### 多文件操作层
- 不同文件操作层可以进行不同的处理(这里是使用一个文件演示)
- 可以使用data传递他处理过的数据

```ts
[
        {
            name: 'file1',
            path: './def1.ts', list: [
                {
                    query: `LetKeyword`,
                    callback: (context) => {
                        context.data = context.getNodeValue()
                    },
                }
            ]
        }, {
            path: './def1.ts', list: [
                {
                    query: `Identifier`,
                    callback: async (context) => {
                        return util.setChange.contextNode(context, context.getContext('root.file1.0').data)
                    },
                }
            ]
        }
]
```
```diff
- let a = 6;
+ let let = 6;
  let b= '123';
```

### 上下文映射修改
- 默认情况下,上下文是从父级获取(最上面有效的上下文则是根据文件/输入内容确定)
- 也可以更改父级查询节点

```ts
{
    path: './def1.ts', list: [
        {
            query: `VariableDeclarationList`,
        },
        {
            query: `NumericLiteral`,
            children: [
                { parentMap: 'parent2.0', query: `Identifier`, replace: `changed` }
            ]
        },
    ]
}
```
- 正常情况下`NumericLiteral`节点后面没有任何节点,但是可以通过变更父节点查询到内容

```diff
- let a = 6;
+ let changed = 6;
  let b= '123';
```
---
### like
- 搜索指定文件,匹配对应内容
- [like模式](./模式/like.md)

```ts
{ query: 'let a=[[$var]]', mode: 'like', replace: { var: '7' } }
```

```diff
- let a = 6;
+ let a = 7;
  let b= '123';
```

### replace
- `replace`传入为对象时,表示替换infer属性中的值;其他情况表示替换匹配节点的值

```ts
{ query: 'NumericLiteral', replace:'7' } // 数字字面量替换为7
{ query: 'let a=[[$var]]', mode: 'like', replace:'let a=7' } // 将整个内容替换为 let a=7
{ query: 'let a=[[$var]]', mode: 'like', replace: { var: '7' } } // 匹配变量var替换为7
{ query: 'let a=[[$var]]', mode: 'like', replace: { var: (context,node)=>{return {value:'7'}} } } // 匹配变量var替换为7
```

## 更多
- 文档正在不断完善,可能有些功能并没有展示,如果遇到相关问题,可以到[Issues](https://github.com/wszgrcy/code-recycle/issues)中提问